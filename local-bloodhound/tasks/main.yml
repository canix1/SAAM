---
- name: Install Docker Desktop via Chocolatey
  win_chocolatey:
    name: docker-desktop
    state: present
    choco_args: --ia /quiet
  # Docker Desktop requires a reboot/logout to finish group membership updates
  register: docker_install

- name: Ensure Docker Desktop is started (User session required)
  win_shell: |
    & "C:\Program Files\Docker\Docker\Docker Desktop.exe"
  async: 10
  poll: 0

- name: Create BloodHound directory
  win_file:
    path: C:\BloodHound
    state: directory

- name: Download BloodHound CE Docker Compose file
  win_get_url:
    url: https://raw.githubusercontent.com/SpecterOps/BloodHound/main/examples/docker-compose/docker-compose.yml
    dest: C:\BloodHound\docker-compose.yml

- name: Generate random password for BloodHound
  set_fact:
    bh_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') }}"

- name: Create .env file for BloodHound
  win_copy:
    dest: C:\BloodHound\.env
    content: |
      POSTGRES_USER=bloodhound
      POSTGRES_PASSWORD={{ bh_password }}
      POSTGRES_DB=bloodhound
      NEO4J_AUTH=neo4j/{{ bh_password }}

- name: Start BloodHound CE via Docker Compose
  win_shell: |
    Set-Location C:\BloodHound
    docker compose up -d
  # This might fail if Docker hasn't fully initialized after the first install; 
  # in a real scenario, you might need a reboot task or wait loop here.
